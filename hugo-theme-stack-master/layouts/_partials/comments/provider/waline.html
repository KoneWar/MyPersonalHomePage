<link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style>

{{- with .Site.Params.comments.waline -}}
{{- $config := dict "el" "#waline" "dark" `html[data-scheme="dark"]` -}}
{{- $replaceKeys := dict "serverurl" "serverURL" "requiredmeta" "requiredMeta" "wordlimit" "wordLimit" "pagesize" "pageSize" "imageuploader" "imageUploader" "texrenderer" "texRenderer" "turnstilekey" "turnstileKey" -}}

{{- range $key, $val := . -}}
    {{- if ne $val nil -}}  
        {{- $replaceKey := index $replaceKeys $key -}}
        {{- $k := default $key $replaceKey -}}

        {{- $config = merge $config (dict $k $val) -}}
    {{- end -}}
{{- end -}}

<script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init(Object.assign({{ $config | jsonify | safeJS }}, {
        path: window.location.pathname.replace(/\/$/, '') + '/',
        locale: {
            nick: '昵称',
            placeholder: '欢迎评论~'
        }
    }));
    
    // 延迟注入 placeholder
    // 因为 Waline 是异步渲染的，使用 MutationObserver 或简单的 setTimeout 来注入属性
    const waitForWaline = () => {
        const nickInput = document.querySelector('#waline input[name="nick"]');
        if (nickInput) {
            nickInput.setAttribute('placeholder', '请输入昵称再评论哦~');
        } else {
            setTimeout(waitForWaline, 500);
        }
    };
    waitForWaline();
</script>
{{- end -}}
